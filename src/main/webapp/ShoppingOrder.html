<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>订单支付页</title>
    <link rel="stylesheet" href="./css/common.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js" type="text/javascript" charset="utf-8"></script>
    <!-- 引入ElementUI样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- 引入ElementUI组件库 -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>


</head>
<body>
<div id="main">
    <div class="container">
        <div id="orderPayment">
            <h1 style="margin-left: 850px;">订单支付页</h1>
            <div v-for="(item, index) in newProductList" :key="index" style="display: flex;">
                <div class="goods-image1" style="margin-left: 550px;">
                    <img v-bind:src="item.pro_img">
                </div>

                <div style="margin-left: 15px;">
                   <p>{{item.pro_name}}</p>
                    <p>{{item.pro_price}} * {{item.pro_num}}</p>
                </div>
            </div>

            <div style="margin-left: 550px;margin-bottom: 14px;">总价格： {{getTotal}}</div>

            <el-button style="margin-left: 550px;margin-bottom: 14px;" @click="sureClick" type="primary">支付</el-button>

            <el-dialog
                    title="支付"
                    :close-on-click-modal="false"
                    :modal="false"
                    :append-to-body="true"
                    :visible.sync="paymentVisable"
                    width="40%">
                <p slot="title" class="dialog-full-header">
                    <i class="el-icon-warning"></i><span class="dialog-full-title">支付提示</span>
                </p>
                <el-radio v-model="radio" label="1">微信</el-radio>
                <el-radio v-model="radio" label="2">Alipay</el-radio>
                <span slot="footer" class="dialog-footer">
                        <el-button type="primary" @click="paymentMoney()">确认支付</el-button>
                        <el-button @click="paymentVisable=false">取消</el-button>
                    </span>
            </el-dialog>
        </div>
    </div>
</div>

</body>

<script src="https://cdn.bootcdn.net/ajax/libs/axios/0.18.1/axios.min.js"></script>
<script src="jQuery.js"></script>
<script type="text/javascript">
    new Vue({
        el:"#orderPayment",
        data:{
            radio: "1",
            paymentVisable: false,
            newProductList: [],
            productList:[
                /*{
                    'pro_name': '颐莲（RELLET） 玻尿酸补水喷雾 补水保湿水润定妆爽肤水化妆水 喷雾300ml',//产品名称
                    'pro_purity': '50ml',//规格
                    'pro_service': "No seven-day no-questions-asked returns",//售后
                    'pro_num': 1,//数量
                    'pro_img': 'img/1.jpg',//图片链接
                    'pro_price': 298,//单价,
                    'select': true ,//选中状态
                },
                {
                    'pro_name': '雅诗兰黛升级款小棕瓶特润修护精华眼霜15ml熬夜眼霜淡化细纹淡化黑眼圈护肤品套装礼盒生日礼物',//产品名称
                    'pro_purity': '350g',//规格
                    'pro_service': "No seven-day no-questions-asked returns",//售后
                    'pro_num': 1,//数量
                    'pro_img': 'img/2.jpg',//图片链接
                    'pro_price': 468,//单价
                    'select': true //选中状态
                },
                {
                    'pro_name': '娥佩兰OPERA 薏苡仁化妆水500ml（cosme大赏薏仁水 爽肤水 温和不刺激 嫩肤水 补水保湿喷雾 日本）',//产品名称
                    'pro_purity': '50ml',//规格
                    'pro_service': "No seven-day no-questions-asked returns",//售后
                    'pro_num': 1,//数量
                    'pro_img': 'img/3.jpg',//图片链接
                    'pro_price': 198,//单价
                    'select': true //选中状态
                }*/
            ]
        },
        computed:{
            getTotal:function(){
                var price=0;
                for(var i=0;i<this.newProductList.length;i++){
                    price+=this.newProductList[i].pro_num*this.newProductList[i].pro_price
                }
                return price.toFixed(2)
            },
        },
        created() {
            debugger
            var _this = this;

            axios({
                method:"get",
                // url:"http://localhost:8080/asd/selectAllServlet"
                // 这里的 uid 添加成你们用户的，那个用户登录，就把那个用户的id放进去就好了，
                url:"./cartServlet?uid=1"
            }).then(function (resp) {
                console.log(resp.data)
                console.log(_this.productList)
                for (let i = 0; i < resp.data.length; i++) {
                    var tep={
                        'id': resp.data[i].id,//产品id
                        'pro_name': resp.data[i].brandName,//产品名称
                        'pro_num': resp.data[1].status,//数量
                        'pro_purity':resp.data[1].companyName,
                        'pro_service':resp.data[1].description,
                        // 'pro_img': 'img/1.jpg',//图片链接
                        'pro_price': resp.data[i].ordered,//单价,
                        'select': true ,//选中状态
                    }
                    _this.productList.push(tep)

                }

                _this.newProductList = []
                var url = window.location.href
                var searParam = decodeURI(url.split("=")[1])
                var arr1 = searParam.split(":")
                for(let i=0;i<arr1.length;i++) {
                    let arr2 = arr1[i].split(",")
                    let arr3 = _this.productList.filter(function(val){
                        return val.id + "" ===arr2[0] + "";
                    })
                    if(arr3.length > 0) {
                        arr3[0].pro_num = arr2[1]
                        _this.newProductList.push(arr3[0])
                    }
                }

                console.log(_this.productList)
            })


        },
        methods:{
            sureClick: function(){
               this.paymentVisable = true
            },
            paymentMoney: function(){
                this.paymentVisable = false
                $.post("saveOrder?action=save",{orderDetail:JSON.stringify(this.newProductList),totalMoney: this.getTotal},
                    function(delFlag){
                        var flag = eval('('+delFlag+')');
                        if(flag){
                            alert("支付成功!");
                        }else{
                            alert("支付失败!");
                        }
                    }
                );
            },
        }

    })
</script>
</html>
